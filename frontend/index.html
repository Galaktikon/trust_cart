/************************************************************ 
 * TrustCart - Frontend Logic (Auth + Products + Plaid Link)
 * Authorization: Bearer <supabase_jwt>
 *
 * Backend endpoints used:
 *  - GET  /test
 *  - POST /create_link_token
 *  - POST /exchange_public_token
 *
 * See per-function JSDoc for expected response shapes.
 ************************************************************/

// Backend for Plaid endpoints, test endpoint, etc.
const API_BASE_URL = "https://trust-cart-backend.onrender.com";

// Supabase Configuration (public anon key is OK in frontend)
const SUPABASE_URL = "https://semkimaoxlmxtyhlhada.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlbWtpbWFveGxteHR5aGxoYWRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjMyNzIsImV4cCI6MjA3ODg5OTI3Mn0.RaOsVMI2UQULkWCYgJGntpNpndaqM1HIi4XHOkJb9kY";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// Plaid state
let plaidInitialized = false;
let plaidHandler = null;

/************************************************************
 * Main script
 ************************************************************/

document.addEventListener("DOMContentLoaded", async () => {
  /* =======================================================
   *  DOM ELEMENTS
   * ======================================================= */

  // High-level sections for auth gating
  const authSection = document.getElementById("authSection");
  const dashboardSection = document.getElementById("dashboard");
  const logoutBtn = document.getElementById("logoutBtn");

  // Auth forms / fields
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");
  const showRegister = document.getElementById("showRegister");
  const showLogin = document.getElementById("showLogin");

  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");

  const regName = document.getElementById("regName");
  const regEmail = document.getElementById("regEmail");
  const regPassword = document.getElementById("regPassword");

  // Dashboard elements
  const bankSection = document.getElementById("bank");
  const linkButton = document.getElementById("link-bank-btn");

  const merchantProductsList = document.getElementById("merchantProducts");
  const statTotalProducts = document.getElementById("statTotalProducts");
  const statTotalValue = document.getElementById("statTotalValue");
  const statTotalOrders = document.getElementById("statTotalOrders");

  const uploadForm = document.getElementById("uploadItemForm");
  const itemTitle = document.getElementById("itemTitle");
  const itemPrice = document.getElementById("itemPrice");
  const itemDescription = document.getElementById("itemDescription");
  const itemImage = document.getElementById("itemImage");

  /* =======================================================
   *  HELPERS
   * ======================================================= */

  function showToast(message, type = "info") {
    const box = document.createElement("div");
    box.textContent = message;
    box.style.position = "fixed";
    box.style.top = "20px";
    box.style.right = "20px";
    box.style.padding = "12px 18px";
    box.style.borderRadius = "10px";
    box.style.fontSize = "14px";
    box.style.zIndex = "9999";
    box.style.transition = "opacity 0.3s ease, transform 0.3s ease";
    box.style.transform = "translateY(0)";

    if (type === "success") {
      box.style.background = "#4ade80";
      box.style.color = "#064e3b";
    } else if (type === "error") {
      box.style.background = "#f87171";
      box.style.color = "#fff";
    } else {
      box.style.background = "#e5e7eb";
      box.style.color = "#111827";
    }

    document.body.appendChild(box);

    setTimeout(() => {
      box.style.opacity = "0";
      box.style.transform = "translateY(-10px)";
      setTimeout(() => box.remove(), 300);
    }, 2000);
  }

  function isValidEmail(email) {
    return /\S+@\S+\.\S+/.test(email);
  }

  function isValidPassword(pass) {
    return pass.length >= 6;
  }

  /**
   * Simple UI mode helpers:
   *  - showAuthUI(): only login/register visible
   *  - showDashboardUI(): only dashboard visible
   */
  function showAuthUI() {
    if (authSection) authSection.classList.remove("hidden");
    if (dashboardSection) dashboardSection.classList.add("hidden");
    if (logoutBtn) logoutBtn.classList.add("hidden");
  }

  function showDashboardUI() {
    if (authSec
